#! /usr/bin/make -f
# -*- makefile -*-
#
# debian/rules
# Part of Gracie, an OpenID provider
#
# Copyright Â© 2007 Ben Finney <ben@benfinney.id.au>
# This is free software; you may copy, modify and/or distribute this work
# under the terms of the GNU General Public License, version 2 or later.
# No warranty expressed or implied. See the file LICENSE for details.

# Uncomment this to turn on verbose mode.
### export DH_VERBOSE=1

PACKAGE_NAME = gracie
MODULE_NAME = ${PACKAGE_NAME}

PYVERS = $(shell pyversions -vr)
DEB_UPSTREAM_VERSION = $(shell dpkg-parsechangelog \
	| grep '^Version:' | cut -d ' ' -f 2 \
	| cut -d '-' -f 1)

.PHONY: build
build: build-stamp

build-stamp: ${PYVERS:%=build-python%}
	dh_testdir
	$(MAKE)
	docbook-to-man debian/gracie.sgml > gracie.1
	touch $@

build-python%:
	dh_testdir
	python$* setup.py build
	touch $@

.PHONY: clean
clean:
	dh_testdir
	dh_testroot
	rm -f build-stamp build-python*
	-$(MAKE) clean
	dh_clean

.PHONY: install
install: build ${PYVERS:%=install-python%}
	dh_testdir
	dh_testroot
	dh_clean -k 
	dh_installdirs
	dh_installinit
	dh_installpam

install-python%:
	python$* setup.py install \
		--single-version-externally-managed \
		--root $(CURDIR)/debian/${PACKAGE_NAME}
	# install only one Egg dir (without python's version number)
	mv debian/${PACKAGE_NAME}/usr/lib/python$*/site-packages/${MODULE_NAME}{-${DEB_UPSTREAM_VERSION}-py$*,}.egg-info


.PHONY: binary-indep
binary-indep: build install

.PHONY: binary-arch
binary-arch: build install
	dh_testdir
	dh_testroot
	dh_installchangelogs 
	dh_installdocs
	dh_installexamples
	dh_installman
	dh_pycentral
	dh_link
	dh_strip
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

.PHONY: binary
binary: binary-indep binary-arch

