#! /usr/bin/make -f
# -*- makefile -*-
#
# debian/rules
# Part of Gracie, an OpenID provider
#
# Copyright Â© 2007 Ben Finney <ben@benfinney.id.au>
# This is free software; you may copy, modify and/or distribute this work
# under the terms of the GNU General Public License, version 2 or later.
# No warranty expressed or implied. See the file LICENSE for details.

# Uncomment this to turn on verbose mode.
### export DH_VERBOSE=1

PACKAGE_NAME = gracie
MODULE_NAME = ${PACKAGE_NAME}

PYVER = $(shell pyversions -dv)
DEB_UPSTREAM_VERSION = $(shell dpkg-parsechangelog \
	| grep '^Version:' | cut -d ' ' -f 2 \
	| cut -d '-' -f 1)
DEB_PYTHON_INSTALL_ARGS_ALL += --single-version-externally-managed
DEB_PYTHON_INSTALL_ARGS_ALL += --root $(CURDIR)/debian/${PACKAGE_NAME}

MANPAGES = $(shell cat $(CURDIR)/debian/${PACKAGE_NAME}.manpages)

.PHONY: build
build: build-stamp

build-stamp: ${MANPAGES}
	dh_testdir
	$(MAKE) build
	python${PYVER} setup.py build
	touch $@

%.1: %.1.sgml
	docbook-to-man $< > $@

%.8: %.8.sgml
	docbook-to-man $< > $@

.PHONY: clean
clean:
	dh_testdir
	dh_testroot
	rm -f *-stamp
	rm -f ${MANPAGES}
	$(MAKE) clean
	dh_clean

.PHONY: install
install: build
	dh_testdir
	dh_testroot
	dh_installdirs
	dh_installinit
	dh_installpam

	python${PYVER} setup.py install ${DEB_PYTHON_INSTALL_ARGS_ALL}
	# install only one Egg dir (without python's version number)
	mv debian/${PACKAGE_NAME}/usr/lib/python${PYVER}/site-packages/${MODULE_NAME}-${DEB_UPSTREAM_VERSION}-py${PYVER}.egg-info \
		debian/${PACKAGE_NAME}/usr/lib/python${PYVER}/site-packages/${MODULE_NAME}.egg-info

.PHONY: binary-indep
binary-indep: build install

.PHONY: binary-arch
binary-arch: build install
	dh_testdir
	dh_testroot
	dh_installchangelogs
	dh_installdocs
	dh_installexamples
	dh_installman
	dh_pycentral
	dh_link
	dh_strip
	dh_compress
	dh_fixperms
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

.PHONY: binary
binary: binary-indep binary-arch
	dh_clean -k

